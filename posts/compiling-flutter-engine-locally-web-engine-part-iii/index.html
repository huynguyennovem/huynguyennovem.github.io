<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Compiling Flutter Engine Locally - Web engine (Part III) - Huy Nguyen Blog</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Compiling Flutter Engine Locally - Web engine (Part III)";
        var mkdocs_page_input_path = "posts/compiling-flutter-engine-locally-web-engine-part-iii.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Huy Nguyen Blog
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../">Posts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../community_activities/">Community Activities</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../projects_packages/">Projects and packages</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../contributions/">Contributions</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Huy Nguyen Blog</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Compiling Flutter Engine Locally - Web engine (Part III)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>In this part, we will try building Web engine and also handle some errors that may happen during the build. We will use <code>felt</code> tool for this. Before using it, let's add it to your PATH environment variables. The path would be: <code>ENGINE_ROOT/src/flutter/lib/web_ui/dev</code>. For e.g:</p>
<pre><code class="language-bash">export PATH=/Users/huynq/Documents/GitHub/engine/src/flutter/lib/web_ui/dev:$PATH
</code></pre>
<p>Then you can call <code>felt</code> command from anywhere.</p>
<p>Next, as common steps stated in previous tutorials, we need to check out engine commit we want to build with and also update dependencies. In this tutorial, I assume we use the latest engine revision from main branch.</p>
<ol>
<li>Update the Flutter Engine repo:</li>
</ol>
<pre><code class="language-bash">âžœ  cd /Users/huynq/Documents/GitHub/engine/src/flutter
âžœ  git pull upstream main
</code></pre>
<ol>
<li>Update dependencies</li>
</ol>
<pre><code class="language-bash">âžœ  engine gclient sync
Syncing projects: 100% (137/137), done.                                                                            
Hook 'python3 src/flutter/tools/pub_get_offline.py' took 14.53 secs
Running hooks: 100% (14/14), done.
</code></pre>
<ol>
<li>Felt build</li>
</ol>
<p>This command will build Web engine target. Some targets could be used with: <code>sdk</code>, <code>canvaskit</code>, <code>canvaskit_chromium</code> and <code>skwasm</code>. You can check them all <a href="https://github.com/flutter/engine/blob/main/lib/web_ui/README.md#felt-build">here</a>.</p>
<pre><code class="language-bash">âžœ  src git:(44ca359) felt build
Running on MacOS. Will check the file and user limits.
File limits too low increasing the file limits
User limits too low increasing the user limits
Running `dart pub get` in 'engine/src/flutter/lib/web_ui'
Running gn...
Generating GN files in: out/wasm_release
Generating compile_commands took 39ms
Done. Made 185 targets from 94 files in 3169ms
Running autoninja...
ninja: Entering directory `/Users/huynq/Documents/GitHub/engine/src/out/wasm_release'
[139/2539] LINK canvaskit/canvaskit.js
cache:INFO: generating system asset: symbol_lists/266569fa9c69a946597f128c95d4d54feb22c5ff.json... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/symbol_lists/266569fa9c69a946597f128c95d4d54feb22c5ff.json&quot; for subsequent builds)
cache:INFO:  - ok
[2530/2539] LINK skwasm/skwasm.js
cache:INFO: generating system asset: symbol_lists/8332cd38f4026705eee5a4cdaee53cba8dad116b.json... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/symbol_lists/8332cd38f4026705eee5a4cdaee53cba8dad116b.json&quot; for subsequent builds)
cache:INFO:  - ok
cache:INFO: generating system asset: sysroot/lib/wasm32-emscripten/lto/crtbegin.o... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/crtbegin.o&quot; for subsequent builds)
system_libs:INFO: compiled 1 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libGL-mt-webgl2.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libGL-mt-webgl2.a&quot; for subsequent builds)
system_libs:INFO: compiled 4 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libc_optz-mt.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libc_optz-mt.a&quot; for subsequent builds)
system_libs:INFO: compiled 7 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libbulkmemory.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libbulkmemory.a&quot; for subsequent builds)
system_libs:INFO: compiled 4 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libnoexit.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libnoexit.a&quot; for subsequent builds)
system_libs:INFO: compiled 1 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libc-mt.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libc-mt.a&quot; for subsequent builds)
system_libs:INFO: compiled 1108 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libdlmalloc-mt.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libdlmalloc-mt.a&quot; for subsequent builds)
system_libs:INFO: compiled 1 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libcompiler_rt-mt.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libcompiler_rt-mt.a&quot; for subsequent builds)
system_libs:INFO: compiled 175 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libc++-mt-noexcept.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libc++-mt-noexcept.a&quot; for subsequent builds)
system_libs:INFO: compiled 49 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libc++abi-mt-noexcept.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libc++abi-mt-noexcept.a&quot; for subsequent builds)
system_libs:INFO: compiled 16 inputs
cache:INFO:  - ok
cache:INFO: generating system library: sysroot/lib/wasm32-emscripten/lto/libsockets-mt.a... (this will be cached in &quot;/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/lto/libsockets-mt.a&quot; for subsequent builds)
system_libs:INFO: compiled 21 inputs
cache:INFO:  - ok
[2539/2539] STAMP obj/default.stamp
âžœ  src git:(44ca359)
</code></pre>
<ol>
<li>Run your Flutter project</li>
</ol>
<pre><code class="language-bash">âžœ  flutterm create demo_web_engine
âžœ  cd demo_web_engine
âžœ  demo_web_engine flutterm --local-web-sdk=wasm_release run -d chrome --local-engine-src-path=/Users/huynq/Documents/GitHub/engine/src
Launching lib/main.dart on Chrome in debug mode...
Warning: In index.html:37: Local variable for &quot;serviceWorkerVersion&quot; is deprecated. Use &quot;{{flutter_service_worker_version}}&quot; template token instead.
Warning: In index.html:46: &quot;FlutterLoader.loadEntrypoint&quot; is deprecated. Use &quot;FlutterLoader.load&quot; instead.
Waiting for connection from debug service on Chrome...             22.8s
This app is linked to the debug service: ws://127.0.0.1:58589/P1bktcnKBgw=/ws
Debug service listening on ws://127.0.0.1:58589/P1bktcnKBgw=/ws

ðŸ”¥  To hot restart changes while running, press &quot;r&quot; or &quot;R&quot;.
For a more detailed help message, press &quot;h&quot;. To quit, press &quot;q&quot;.

A Dart VM Service on Chrome is available at: http://127.0.0.1:58589/P1bktcnKBgw=
The Flutter DevTools debugger and profiler on Chrome is available at: http://127.0.0.1:9100?uri=http://127.0.0.1:58589/P1bktcnKBgw=
</code></pre>
<h3 id="troubleshooting">Troubleshooting</h3>
<ol>
<li>felt build failed: <code>buildtools/emsdk/upstream/emscripten/em++: No such file or directory</code></li>
</ol>
<pre><code class="language-bash">âžœ  src git:(44ca359) felt build
Running on MacOS. Will check the file and user limits.
File limits too low increasing the file limits
Password:
User limits too low increasing the user limits
Running `dart pub get` in 'engine/src/flutter/lib/web_ui'
Running gn...
Generating GN files in: out/wasm_release
Generating compile_commands took 44ms
Done. Made 185 targets from 94 files in 3670ms
Running autoninja...
ninja: Entering directory `/Users/huynq/Documents/GitHub/engine/src/out/wasm_release'
[7/4197] CXX canvaskit/obj/flutter/third_party/skia/src/ports/fontmgr_custom.SkFontMgr_custom.o
FAILED: canvaskit/obj/flutter/third_party/skia/src/ports/fontmgr_custom.SkFontMgr_custom.o 
/Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/em++ --em-config /Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/.emscripten -MD -MF canvaskit/obj/flutter/third_party/skia/src/ports/fontmgr_custom.SkFontMgr_custom.o.d -DUSE_OPENSSL=1 -D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS -DNDEBUG -DNVALGRIND -DDYNAMIC_ANNOTATIONS_ENABLED=0 -DSK_ENABLE_DUMP_GPU -DSK_FORCE_AAA -DSK_LEGACY_IGNORE_DRAW_VERTICES_BLEND_WITH_NO_SHADER -DSK_DISABLE_LEGACY_GRDIRECTCONTEXT_BOOLS -DSK_DISABLE_LEGACY_GRDIRECTCONTEXT_FLUSH -DSK_RESOLVE_FILTERS_BEFORE_RESTORE -DSK_DISABLE_LEGACY_SHADERCONTEXT -DSK_DISABLE_LOWP_RASTER_PIPELINE -DSK_FORCE_RASTER_PIPELINE_BLITTER -DSK_METAL_WAIT_UNTIL_SCHEDULED -DSK_DISABLE_EFFECT_DESERIALIZATION -DSK_ENABLE_PRECOMPILE -DSKNX_NO_SIMD -DSK_FORCE_8_BYTE_ALIGNMENT -DSK_DISABLE_TRACING -DSK_ASSUME_WEBGL=1 -DSK_USE_WEBGL -DSK_GANESH -DSK_GAMMA_APPLY_TO_A8 -DSKIA_IMPLEMENTATION=1 -DSK_TYPEFACE_FACTORY_FREETYPE -I../.. -Icanvaskit/gen -I../../flutter/third_party/skia -fno-strict-aliasing -fcolor-diagnostics -Wendif-labels -Werror -Wno-missing-field-initializers -Wno-unused-parameter -Wno-shift-negative-value -Wno-unused-function -Wno-unused-variable -Wno-unused-but-set-parameter -Wno-unused-but-set-variable -Wno-implicit-int-float-conversion -Wno-deprecated-copy -Wno-psabi -Wno-deprecated-literal-operator -Wno-non-c-typedef-for-linkage -Wno-range-loop-construct -Wstring-conversion -Wnewline-eof -O3 -g0 -fvisibility-inlines-hidden -std=c++17 -fno-rtti   -c ../../flutter/third_party/skia/src/ports/SkFontMgr_custom.cpp -o canvaskit/obj/flutter/third_party/skia/src/ports/fontmgr_custom.SkFontMgr_custom.o
/bin/sh: /Users/huynq/Documents/GitHub/engine/src/buildtools/emsdk/upstream/emscripten/em++: No such file or directory
[16/4197] ACTION //flutter/web_sdk:web_engine_library(//build/toolchain/wasm:wasm)
ninja: build stopped: subcommand failed.
Pipeline experienced the following failures:
  &quot;ninja&quot;: Sub-process failed.
Command: autoninja -C /Users/huynq/Documents/GitHub/engine/src/out/wasm_release
Working directory: /Users/huynq/Documents/GitHub/engine/src/flutter/lib/web_ui
Exit code: 1

Test pipeline failed.
</code></pre>
<p>It's telling <code>emsdk</code> is missing from <code>buildtools</code> dir. You need to add it manually:</p>
<ul>
<li>Step 1: Add <code>download_emsdk</code> to <code>engine/.gclient</code> file as below:</li>
</ul>
<pre><code class="language-bash">solutions = [
  {
    &quot;managed&quot;: False,
    &quot;name&quot;: &quot;src/flutter&quot;,
    &quot;url&quot;: &quot;git@github.com:huycozy/engine.git&quot;,
    &quot;custom_deps&quot;: {},
    &quot;deps_file&quot;: &quot;DEPS&quot;,
    &quot;safesync_url&quot;: &quot;&quot;,
    &quot;custom_vars&quot;: {&quot;download_emsdk&quot;: True},
  },
]
</code></pre>
<ul>
<li>Step 2: Update dependencies again</li>
</ul>
<pre><code class="language-bash">âžœ  engine gclient sync
</code></pre>
<p>Then you will see <code>emsdk</code> is downloaded in <code>buildtools</code>.</p>
<ol>
<li><code>web</code> dependency error</li>
</ol>
<p>You may hit errors like:</p>
<pre><code class="language-dart">               ^
../../.pub-cache/hosted/pub.dev/web-0.5.1/lib/src/dom/webrtc_encoded_transform.dart:148:34: Error: Type 'invalid-type' is not a valid type for external `dart:js_interop` APIs. The only valid types are: @staticInterop types, JS types from `dart:js_interop`, void, bool, num, double, int, String, and any extension type that erases to one of these types.
Use one of the valid types instead.
  external JSArray&lt;JSNumber&gt; get contributingSources;
                                 ^
../../.pub-cache/hosted/pub.dev/web-0.5.1/lib/src/dom/webrtc_encoded_transform.dart:216:32: Error: Type 'invalid-type' is not a valid type for external `dart:js_interop` APIs. The only valid types are: @staticInterop types, JS types from `dart:js_interop`, void, bool, num, double, int, String, and any extension type that erases to one of these types.
Use one of the valid types instead.
  external JSPromise&lt;JSNumber&gt; generateKeyFrame([String rid]);
                               ^
../../.pub-cache/hosted/pub.dev/web-0.5.1/lib/src/dom/webrtc_encoded_transform.dart:237:30: Error: Type 'invalid-type' is not a valid type for external `dart:js_interop` APIs. The only valid types are: @staticInterop types, JS types from `dart:js_interop`, void, bool, num, double, int, String, and any extension type that erases to one of these types.
Use one of the valid types instead.
  external JSPromise&lt;JSAny?&gt; sendKeyFrameRequest();
                             ^
../../.pub-cache/hosted/pub.dev/web-0.5.1/lib/src/dom/webrtc_encoded_transform.dart:252:20: Error: Type 'invalid-type' is not a valid type for external `dart:js_interop` APIs. The only valid types are: @staticInterop types, JS types from `dart:js_interop`, void, bool, num, double, int, String, and any extension type that erases to one of these types.
Use one of the valid types instead.
  external factory RTCRtpScriptTransform(
                   ^
../../.pub-cache/hosted/pub.dev/web-0.5.1/lib/src/dom/xhr.dart:263:40: Error: Type 'invalid-type' is not a valid type for external `dart:js_interop` APIs. The only valid types are: @staticInterop types, JS types from `dart:js_interop`, void, bool, num, double, int, String, and any extension type that erases to one of these types.
Use one of the valid types instead.
  external JSArray&lt;FormDataEntryValue&gt; getAll(String name);
                                       ^
Failed to compile application.
</code></pre>
<p>It could be <code>web</code> package version depreciation issue. Just try downgrading package version then retry.</p>
<pre><code class="language-bash">dart pub downgrade web
</code></pre>
<p>Or use a specific package version in project:</p>
<pre><code class="language-yaml">dependencies:
  flutter:
    sdk: flutter
  web: 0.4.2
</code></pre>
<p>Hope this will be useful for you!</p>
<p>Stay in touch with me for updates:</p>
<ul>
<li>
<p>Twitter: <a href="https://twitter.com/HuyNguyenTw">https://twitter.com/HuyNguyenTw</a></p>
</li>
<li>
<p>GitHub: <a href="https://github.com/huynguyennovem">https://github.com/huynguyennovem</a></p>
</li>
<li>
<p>LinkedIn: <a href="https://linkedin.com/in/huynguyennovem">https://linkedin.com/in/huynguyennovem</a></p>
</li>
</ul>
<h3 id="references">References</h3>
<ul>
<li>
<p><a href="https://github.com/flutter/flutter/wiki/Compiling-the-engine#compiling-for-the-web">https://github.com/flutter/flutter/wiki/Compiling-the-engine#compiling-for-the-web</a></p>
</li>
<li>
<p><a href="https://github.com/flutter/engine/blob/main/lib/web_ui/README.md">https://github.com/flutter/engine/blob/main/lib/web_ui/README.md</a></p>
</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
